<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Farmer Profile - AgroFlow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
    <style>
        /* Your full CSS from other pages should be here for consistency */
        :root { --primary-color: #1e5631; --secondary-color: #4c9f70; --accent-color: #d4a017; --background-color: #f8f9fa; --card-color: #ffffff; --text-color: #333333; --light-text: #6c757d; --border-color: #dee2e6; --success-color: #28a745; --info-color: #17a2b8; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--background-color); color: var(--text-color); }
        a { text-decoration: none; color: inherit; }
        .header { background-color: var(--primary-color); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { display: flex; align-items: center; font-size: 1.5rem; font-weight: 700; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-profile img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .horizontal-nav { background-color: white; padding: 0 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: center; }
        .nav-items { display: flex; }
        .nav-item { padding: 15px 20px; font-weight: 600; }
        .main-content { padding: 30px; max-width: 1400px; margin: auto; }
        .profile-header { display: flex; align-items: center; gap: 30px; background-color: var(--card-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .profile-header .avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary-color); }
        .profile-header .info h1 { font-size: 2rem; margin: 0; }
        .profile-header .info p { color: var(--light-text); margin: 2px 0; }
        .dashboard-section { background-color: var(--card-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 30px; margin-bottom: 30px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .section-header h2 { color: var(--primary-color); font-size: 1.6rem; }
        .btn { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 700; transition: background-color 0.3s; }
        .btn-info { background-color: var(--info-color); }
        .btn-success { background-color: var(--success-color); }
        .results-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .results-table th, .results-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .results-table th { background-color: rgba(30, 86, 49, 0.05); font-weight: 700; }
                /* Add this to your <style> block if it's not already there */
        .profile-header .stats { display: flex; gap: 20px; margin-left: auto; }
        .stat-item { text-align: center; }
        .stat-item .value { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        .stat-item .label { font-size: 0.9rem; color: var(--light-text); }
    </style>
</head>
<body>
<!-- Header with dynamic officer name -->
<div class="header">
    <div class="logo"><i class="fas fa-leaf"></i> <span>AgroFlow</span></div>
    <div class="user-info">
        <div class="user-profile">
            <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Officer" />
            <span id="userName">Loading...</span>
        </div>
    </div>
</div>

<!-- Navigation -->
<div class="horizontal-nav">
    <div class="nav-items">
        <div class="nav-item"><a href="dashboard.html">Dashboard</a></div>
        <div class="nav-item"><a href="farmer-dashboard.html"><i class="fas fa-arrow-left"></i> Back to Farmer List</a></div>
    </div>
</div>

<div class="main-content">
    <!-- Farmer Profile Header -->
    <div class="profile-header">
        <img src="https://randomuser.me/api/portraits/men/41.jpg" alt="Farmer" class="avatar">
        <div class="info">
            <h1 id="farmerName">Loading...</h1>
            <p><i class="fas fa-phone"></i> <span id="farmerContact"></span> | <i class="fas fa-id-card"></i> <span id="farmerNid"></span></p>
            <p><i class="fas fa-map-marker-alt"></i> <span id="farmerLocation"></span></p>
        </div>
        <div class="stats">
            <div class="stat-item">
                <div class="value" id="totalAcres">--</div>
                <div class="label">Total Acres</div>
            </div>
            <div class="stat-item">
                <div class="value" id="activePlans">--</div>
                <div class="label">Active Plans</div>
            </div>
            <div class="stat-item">
                <div class="value" id="totalSales">--</div>
                <div class="label">Sales</div>
            </div>
        </div>
    </div>

    <!-- Fields Management -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2><i class="fas fa-map"></i> Fields</h2>
            <a href="add-field.html" class="btn">Add New Field</a>
        </div>
        <table class="results-table">
            <thead><tr><th>Name</th><th>Location</th><th>Size (Acres)</th><th>Soil</th><th>Irrigation</th><th>Ownership</th></tr></thead>
            <tbody id="fieldsTableBody"></tbody>
        </table>
    </div>

    <!-- Crop Planning -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2><i class="fas fa-clipboard-list"></i> Crop Plans</h2>
            <a href="add-cropplan.html" class="btn">Add New Crop Plan</a>
        </div>
        <table class="results-table">
            <thead><tr><th>Crop</th><th>Field</th><th>Planting Date</th><th>Expected Harvest</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="cropPlansTableBody"></tbody>
        </table>
    </div>

    <!-- Harvest Records -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2><i class="fas fa-tractor"></i> Harvest Records</h2>
        </div>
        <table class="results-table">
            <thead><tr><th>Crop</th><th>Harvest Date</th><th>Quantity (kg)</th><th>Quality</th><th>Storage</th><th>Actions</th></tr></thead>
            <tbody id="harvestsTableBody"></tbody>
        </table>
    </div>

    <!-- Sales Data -->
    <div class="dashboard-section">
        <div class="section-header">
            <h2><i class="fas fa-dollar-sign"></i> Sales History</h2>
        </div>
        <table class="results-table">
            <thead><tr><th>Crop</th><th>Sale Date</th><th>Quantity (kg)</th><th>Price/kg</th><th>Payment</th><th>Delivery</th></tr></thead>
            <tbody id="salesTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function() {
        // --- 1. HANDLE OFFICER LOGIN STATE ---
        const officerString = sessionStorage.getItem('loggedInOfficer');
        if (officerString) {
            const officer = JSON.parse(officerString);
            document.getElementById('userName').textContent = officer.name;
        } else {
            alert("You are not logged in.");
            window.location.href = 'login.html';
            return;
        }

        // --- 2. GET THE SELECTED FARMER ID ---
        const selectedFarmerId = sessionStorage.getItem('selectedFarmerId');
        if (!selectedFarmerId) {
            alert("No farmer selected. Returning to the farmer list.");
            window.location.href = 'farmer-dashboard.html';
            return;
        }

        // --- 3. FETCH THE FULL PROFILE DATA FROM THE BACKEND ---
        try {
            const response = await fetch(`/api/farmers/${selectedFarmerId}/profile`);
            if (!response.ok) {
                throw new Error(`Failed to fetch farmer profile. Status: ${response.status}`);
            }
            const profile = await response.json();

            // --- 4. POPULATE THE ENTIRE PAGE ---
            populateHeader(profile);
            populateFieldsTable(profile.fields);
            populateCropPlansTable(profile.cropPlans);
            populateHarvestsTable(profile.harvests);
            populateSalesTable(profile.sales);

        } catch (error) {
            console.error("Error fetching farmer profile:", error);
            alert("Could not load farmer data. Please try again.");
        }
    });

    // --- HELPER FUNCTIONS TO POPULATE EACH SECTION ---

    function populateHeader(profile) {
        document.getElementById('farmerName').textContent = profile.name;
        document.getElementById('farmerContact').textContent = profile.contact;
        document.getElementById('farmerNid').textContent = profile.nid;
        document.getElementById('farmerLocation').textContent = `${profile.village}, ${profile.union_name}, ${profile.district}`;
        // --- ADD THESE NEW LINES TO POPULATE THE STATS ---
        document.getElementById('totalAcres').textContent = profile.totalAcres.toFixed(2); // Format to 2 decimal places
        document.getElementById('activePlans').textContent = profile.activeCropPlans;

        // Format the sales value as currency
        const formattedSales = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'BDT', // Or your desired currency
            minimumFractionDigits: 0
        }).format(profile.totalSalesYTD);
        document.getElementById('totalSales').textContent = formattedSales;
    }

    function populateFieldsTable(fields) {
        const tableBody = document.getElementById('fieldsTableBody');
        if (!fields || fields.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No fields registered.</td></tr>';
            return;
        }
        tableBody.innerHTML = fields.map(field => `
            <tr>
                <td>${field.name}</td>
                <td>${field.landmark}</td>
                <td>${field.size}</td>
                <td>${field.soil_type}</td>
                <td>${field.irrigation_type}</td>
                <td>${field.ownership_type}</td>
            </tr>
        `).join('');
    }

    function populateCropPlansTable(cropPlans) {
        const tableBody = document.getElementById('cropPlansTableBody');
        if (!cropPlans || cropPlans.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No crop plans found.</td></tr>';
            return;
        }
        tableBody.innerHTML = cropPlans.map(plan => `
            <tr>
                <td>${plan.crop.name}</td>
                <td>${plan.field.name}</td>
                <td>${new Date(plan.planting_date).toLocaleDateString()}</td>
                <td>${new Date(plan.expected_harvest_date).toLocaleDateString()}</td>
                <td>${plan.status}</td>
                <td>
                    ${plan.status === 'Ongoing' ? `<a href="record-harvest.html" class="btn btn-success">Record Harvest</a>` : '-'}
                </td>
            </tr>
        `).join('');
    }

    function populateHarvestsTable(harvests) {
        const tableBody = document.getElementById('harvestsTableBody');
        if (!harvests || harvests.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No harvests recorded.</td></tr>';
            return;
        }
        tableBody.innerHTML = harvests.map(harvest => `
            <tr>
                <td>${harvest.cropPlan.crop.name}</td>
                <td>${new Date(harvest.harvest_date).toLocaleDateString()}</td>
                <td>${harvest.quantity}</td>
                <td>${harvest.quality_grade}</td>
                <td>${harvest.storage_status}</td>
                <td>
                    <!-- If a sales request has NOT been made for this harvest, show the button -->
                    ${!harvest.salesRequest ? `<a href="request-sale.html" class="btn btn-info">Request to Sell</a>` : 'Requested'}
                </td>
            </tr>
        `).join('');
    }

    function populateSalesTable(sales) {
        const tableBody = document.getElementById('salesTableBody');
        if (!sales || sales.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No sales history found.</td></tr>';
            return;
        }
        tableBody.innerHTML = sales.map(sale => `
            <tr>
                <td>${sale.salesRequest.harvest.cropPlan.crop.name}</td>
                <td>${new Date(sale.sale_date).toLocaleDateString()}</td>
                <td>${sale.final_quantity}</td>
                <td>${sale.final_price_per_kg}</td>
                <td>${sale.payment_status}</td>
                <td>${sale.salesRequest.delivery_status}</td>
            </tr>
        `).join('');
    }
</script>
</body>
</html>